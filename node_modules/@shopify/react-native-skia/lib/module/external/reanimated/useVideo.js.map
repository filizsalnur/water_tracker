{"version":3,"names":["runOnUI","useSharedValue","useCallback","useEffect","useMemo","Skia","Platform","Rea","defaultOptions","playbackSpeed","looping","paused","useOption","value","defaultValue","isSharedValue","useVideo","source","userOptions","_userOptions$paused","_userOptions$looping","_userOptions$playback","video","Video","isPaused","currentFrame","lastTimestamp","startTimestamp","framerate","duration","frameDuration","disposeVideo","dispose","useFrameCallback","frameInfo","timestamp","currentTimestamp","seek","currentFrameDuration","img","nextImage","OS","makeNonTextureImage"],"sources":["useVideo.ts"],"sourcesContent":["import {\n  runOnUI,\n  useSharedValue,\n  type FrameInfo,\n  type SharedValue,\n} from \"react-native-reanimated\";\nimport { useCallback, useEffect, useMemo } from \"react\";\n\nimport { Skia } from \"../../skia/Skia\";\nimport type { SkImage } from \"../../skia/types\";\nimport { Platform } from \"../../Platform\";\n\nimport Rea from \"./ReanimatedProxy\";\n\ntype Animated<T> = SharedValue<T> | T;\n\nexport interface PlaybackOptions {\n  playbackSpeed: Animated<number>;\n  looping: Animated<boolean>;\n  paused: Animated<boolean>;\n}\n\nconst defaultOptions = {\n  playbackSpeed: 1,\n  looping: true,\n  paused: false,\n};\n\nconst useOption = <T>(value: Animated<T>) => {\n  \"worklet\";\n  // TODO: only create defaultValue is needed (via makeMutable)\n  const defaultValue = useSharedValue(\n    Rea.isSharedValue(value) ? value.value : value\n  );\n  return Rea.isSharedValue(value) ? value : defaultValue;\n};\n\nexport const useVideo = (\n  source: string | null,\n  userOptions?: Partial<PlaybackOptions>\n) => {\n  const video = useMemo(() => (source ? Skia.Video(source) : null), [source]);\n  const isPaused = useOption(userOptions?.paused ?? defaultOptions.paused);\n  const looping = useOption(userOptions?.looping ?? defaultOptions.looping);\n  const playbackSpeed = useOption(\n    userOptions?.playbackSpeed ?? defaultOptions.playbackSpeed\n  );\n  const currentFrame = Rea.useSharedValue<null | SkImage>(null);\n  const lastTimestamp = Rea.useSharedValue(-1);\n  const startTimestamp = Rea.useSharedValue(-1);\n\n  const framerate = useMemo(() => (video ? video.framerate() : -1), [video]);\n  const duration = useMemo(() => (video ? video.duration() : -1), [video]);\n  const frameDuration = useMemo(\n    () => (framerate > 0 ? 1000 / framerate : -1),\n    [framerate]\n  );\n  const disposeVideo = useCallback(() => {\n    \"worklet\";\n    video?.dispose();\n  }, [video]);\n\n  Rea.useFrameCallback((frameInfo: FrameInfo) => {\n    if (!video) {\n      return;\n    }\n    if (isPaused.value && lastTimestamp.value !== -1) {\n      return;\n    }\n    const { timestamp } = frameInfo;\n\n    // Initialize start timestamp\n    if (startTimestamp.value === -1) {\n      startTimestamp.value = timestamp;\n    }\n\n    // Calculate the current time in the video\n    const currentTimestamp = timestamp - startTimestamp.value;\n\n    // Handle looping\n    if (currentTimestamp > duration && looping.value) {\n      video.seek(0);\n      startTimestamp.value = timestamp;\n    }\n\n    // Update frame only if the elapsed time since last update is greater than the frame duration\n    const currentFrameDuration = frameDuration / playbackSpeed.value;\n    if (\n      lastTimestamp.value === -1 ||\n      timestamp - lastTimestamp.value >= currentFrameDuration\n    ) {\n      const img = video.nextImage();\n      if (img) {\n        if (currentFrame.value) {\n          currentFrame.value.dispose();\n        }\n        if (Platform.OS === \"android\") {\n          currentFrame.value = img.makeNonTextureImage();\n        } else {\n          currentFrame.value = img;\n        }\n      }\n      lastTimestamp.value = timestamp;\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      // TODO: should video simply be a shared value instead?\n      runOnUI(disposeVideo)();\n    };\n  }, [disposeVideo, video]);\n\n  return currentFrame;\n};\n"],"mappings":"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"}