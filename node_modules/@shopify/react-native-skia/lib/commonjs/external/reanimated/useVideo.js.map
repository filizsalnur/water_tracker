{"version":3,"names":["_reactNativeReanimated","require","_react","_Skia","_Platform","_ReanimatedProxy","_interopRequireDefault","obj","__esModule","default","defaultOptions","playbackSpeed","looping","paused","useOption","value","defaultValue","useSharedValue","Rea","isSharedValue","useVideo","source","userOptions","_userOptions$paused","_userOptions$looping","_userOptions$playback","video","useMemo","Skia","Video","isPaused","currentFrame","lastTimestamp","startTimestamp","framerate","duration","frameDuration","disposeVideo","useCallback","dispose","useFrameCallback","frameInfo","timestamp","currentTimestamp","seek","currentFrameDuration","img","nextImage","Platform","OS","makeNonTextureImage","useEffect","runOnUI","exports"],"sources":["useVideo.ts"],"sourcesContent":["import {\n  runOnUI,\n  useSharedValue,\n  type FrameInfo,\n  type SharedValue,\n} from \"react-native-reanimated\";\nimport { useCallback, useEffect, useMemo } from \"react\";\n\nimport { Skia } from \"../../skia/Skia\";\nimport type { SkImage } from \"../../skia/types\";\nimport { Platform } from \"../../Platform\";\n\nimport Rea from \"./ReanimatedProxy\";\n\ntype Animated<T> = SharedValue<T> | T;\n\nexport interface PlaybackOptions {\n  playbackSpeed: Animated<number>;\n  looping: Animated<boolean>;\n  paused: Animated<boolean>;\n}\n\nconst defaultOptions = {\n  playbackSpeed: 1,\n  looping: true,\n  paused: false,\n};\n\nconst useOption = <T>(value: Animated<T>) => {\n  \"worklet\";\n  // TODO: only create defaultValue is needed (via makeMutable)\n  const defaultValue = useSharedValue(\n    Rea.isSharedValue(value) ? value.value : value\n  );\n  return Rea.isSharedValue(value) ? value : defaultValue;\n};\n\nexport const useVideo = (\n  source: string | null,\n  userOptions?: Partial<PlaybackOptions>\n) => {\n  const video = useMemo(() => (source ? Skia.Video(source) : null), [source]);\n  const isPaused = useOption(userOptions?.paused ?? defaultOptions.paused);\n  const looping = useOption(userOptions?.looping ?? defaultOptions.looping);\n  const playbackSpeed = useOption(\n    userOptions?.playbackSpeed ?? defaultOptions.playbackSpeed\n  );\n  const currentFrame = Rea.useSharedValue<null | SkImage>(null);\n  const lastTimestamp = Rea.useSharedValue(-1);\n  const startTimestamp = Rea.useSharedValue(-1);\n\n  const framerate = useMemo(() => (video ? video.framerate() : -1), [video]);\n  const duration = useMemo(() => (video ? video.duration() : -1), [video]);\n  const frameDuration = useMemo(\n    () => (framerate > 0 ? 1000 / framerate : -1),\n    [framerate]\n  );\n  const disposeVideo = useCallback(() => {\n    \"worklet\";\n    video?.dispose();\n  }, [video]);\n\n  Rea.useFrameCallback((frameInfo: FrameInfo) => {\n    if (!video) {\n      return;\n    }\n    if (isPaused.value && lastTimestamp.value !== -1) {\n      return;\n    }\n    const { timestamp } = frameInfo;\n\n    // Initialize start timestamp\n    if (startTimestamp.value === -1) {\n      startTimestamp.value = timestamp;\n    }\n\n    // Calculate the current time in the video\n    const currentTimestamp = timestamp - startTimestamp.value;\n\n    // Handle looping\n    if (currentTimestamp > duration && looping.value) {\n      video.seek(0);\n      startTimestamp.value = timestamp;\n    }\n\n    // Update frame only if the elapsed time since last update is greater than the frame duration\n    const currentFrameDuration = frameDuration / playbackSpeed.value;\n    if (\n      lastTimestamp.value === -1 ||\n      timestamp - lastTimestamp.value >= currentFrameDuration\n    ) {\n      const img = video.nextImage();\n      if (img) {\n        if (currentFrame.value) {\n          currentFrame.value.dispose();\n        }\n        if (Platform.OS === \"android\") {\n          currentFrame.value = img.makeNonTextureImage();\n        } else {\n          currentFrame.value = img;\n        }\n      }\n      lastTimestamp.value = timestamp;\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      // TODO: should video simply be a shared value instead?\n      runOnUI(disposeVideo)();\n    };\n  }, [disposeVideo, video]);\n\n  return currentFrame;\n};\n"],"mappings":"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"}